<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> بوصلة المسارات </title>


<!-- PWA Manifest Link -->
<link rel="manifest" href="manifest.json">


    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #20A4F3;
            --sidebar-bg: #0D2B45;
            --secondary-color: #0D2B45;
            --accent-color: #FFFFFF;
            --background-color-light: #f4f7fa;
            --text-color-light: #34495e;
            --background-color-dark: #1a1a2e;
            --text-color-dark: #e1e8ed;
            --sidebar-link-color: #e1e8ed;
            --sidebar-link-active-bg: #20A4F3;
            --card-background-light: #ffffff;
            --card-background-dark: #1f2041;
            --border-color-light: #e1e8ed;
            --border-color-dark: #3a3b5a;
            --shadow-color: rgba(13, 43, 69, 0.1);
            --success-color: #2ecc71;
            --success-bg-color: rgba(46, 204, 113, 0.1);
            --incomplete-color: #3498db;
            --incomplete-bg-color: rgba(52, 152, 219, 0.1);
            --pending-color: #e67e22;
            --pending-bg-color: rgba(230, 126, 34, 0.1);
            --font-family: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color-light);
            color: var(--text-color-light);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-link-color); position: fixed; top: 0; right: 0; height: 100%; z-index: 1040; transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 1.5rem; transition: margin-right 0.3s ease-in-out; overflow-x: hidden; }
        
        .sidebar-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header img { width: 80px; height: 80px; margin-bottom: 0.5rem; border-radius: 50%; border: 3px solid var(--primary-color); }
        .sidebar-header h5 { margin: 0; font-weight: 700; color: var(--accent-color); }

        .sidebar-nav { flex-grow: 1; padding: 1rem; list-style: none; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; color: var(--sidebar-link-color); text-decoration: none; padding: 0.85rem 1rem; margin-bottom: 0.5rem; border-radius: 8px; transition: all 0.2s ease-in-out; border-right: 4px solid transparent; }
        .sidebar-nav a:hover { background-color: rgba(255, 255, 255, 0.05); }
        .sidebar-nav a.active { background-color: var(--sidebar-link-active-bg); color: white; font-weight: 700; border-right-color: var(--accent-color); }
        .sidebar-nav svg, .sidebar-nav .fas { width: 22px; height: 22px; text-align: center; }

        .sidebar-footer { padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-footer .form-check-label { color: var(--sidebar-link-color); }

        .menu-toggle { display: none; position: fixed; top: 15px; right: 15px; z-index: 1041; background: var(--card-background-light); border: 1px solid var(--border-color-light); border-radius: 50%; width: 45px; height: 45px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1039; }
        
        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.show { transform: translateX(0); }
            .sidebar.show + .sidebar-overlay { display: block; }
            .main-content { margin-right: 0; width: 100%; }
            .menu-toggle { display: flex; align-items: center; justify-content: center; }
            .page-header { padding-right: 60px; }
        }
        
        /* Dark Mode */
        body.dark-mode { background-color: var(--background-color-dark); color: var(--text-color-dark); }
        body.dark-mode .card, body.dark-mode .modal-content { background-color: var(--card-background-dark); border-color: var(--border-color-dark); color: var(--text-color-dark); }
        body.dark-mode .table { --bs-table-bg: var(--card-background-dark); --bs-table-striped-bg: #2c3034; --bs-table-hover-bg: #32383e; border-color: var(--border-color-dark); color: var(--text-color-dark); }
        body.dark-mode .form-control, body.dark-mode .form-select { background-color: #495057; color: var(--text-color-dark); border-color: #6c757d; }
        body.dark-mode .info-message, body.dark-mode .alert-info { background-color: #2c3e50; color: var(--incomplete-color); border-color: var(--incomplete-color); }
        body.dark-mode .page-header p, body.dark-mode .footer-text, body.dark-mode label, body.dark-mode .assignment-column .card-header { color: #adb5bd; }
        body.dark-mode .menu-toggle { background: var(--card-background-dark); border-color: var(--border-color-dark); color: var(--text-color-dark); }
        body.dark-mode .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        body.dark-mode .nav-tabs .nav-link { color: var(--sidebar-link-color); border-bottom-color: var(--border-color-dark); }
        body.dark-mode .nav-tabs .nav-link.active { background-color: var(--card-background-dark); border-color: var(--border-color-dark); }
        body.dark-mode #journal-table .note-text { color: var(--text-color-dark); }
        body.dark-mode #journal-table .lesson-meta strong { color: var(--text-color-dark); }
        body.dark-mode #journal-table td:nth-child(1),
        body.dark-mode #journal-table td:nth-child(3) {
            color: var(--text-color-dark);
            font-weight: 500;
        }

        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .page-header h1 { color: var(--secondary-color); font-weight: 700; margin: 0; }
        body.dark-mode .page-header h1 { color: var(--primary-color); }
        
        .card { border: 1px solid var(--border-color-light); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px var(--shadow-color); margin-bottom: 1.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .stat-card .label { font-size: 1rem; color: #7f8c8d; }
        
        .instructions-content ul { list-style-type: none; padding-right: 0; }
        .instructions-content > ul > li { margin-bottom: 1.5rem; border-right: 3px solid var(--primary-color); padding-right: 15px; }
        .instructions-content strong { display: block; font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 0.5rem; }
        body.dark-mode .instructions-content strong { color: var(--primary-color); }
        .instructions-content ul ul { padding-right: 20px; }
        .instructions-content ul ul li { margin-bottom: 0.5rem; position: relative; }
        .instructions-content ul ul li::before { content: "\f100"; font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; right: -25px; color: var(--success-color); }
        
        .week-block { margin-bottom: 2rem; }
        .week-title {
            background: linear-gradient(90deg, var(--sidebar-bg), var(--primary-color));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #content-display .session-grid { 
            display: grid; 
            gap: 1rem; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        }
        #content-display .session-card-header { flex-wrap: nowrap; justify-content: space-between; align-items: center; gap: 1rem; }
        #content-display .completion-date-container { display: inline-flex; flex-shrink: 0; align-items: center; white-space: nowrap; }

        .class-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .assignments-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .assignment-column { padding: 0; }
        .assignment-column .card-header { padding: 0.75rem 1rem; background-color: var(--background-color-light); }
        body.dark-mode .assignment-column .card-header { background-color: var(--background-color-dark); }

        .footer-text { margin-top: 2rem; text-align: center; font-size: 0.9em; color: #7f8c8d; }
        .control-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 1.5rem; }
        .control-group > div { flex: 1 1 200px; }
        select, input[type="date"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color-light); background-color: var(--card-background-light); font-size: 1em; }
        .status-toggle { cursor: pointer; font-weight: bold; padding: 5px 10px; border-radius: 5px; user-select: none; transition: all 0.3s; text-align: center; }
        .status-toggle.done { color: var(--success-color); background-color: var(--success-bg-color); }
        .status-toggle.incomplete { color: var(--incomplete-color); background-color: var(--incomplete-bg-color); }
        .status-toggle.pending { color: var(--pending-color); background-color: var(--pending-bg-color); }
        .save-btn { background: var(--primary-color); color: var(--accent-color); border: none; font-weight: bold; padding: 12px 25px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        
        #journal-table th { background-color: var(--sidebar-bg); color: var(--sidebar-link-color); text-align: center; vertical-align: middle; }
        #journal-table td { text-align: center; vertical-align: middle; }
        body.dark-mode #journal-table th { background-color: var(--primary-color); }
        #journal-table .lesson-title { color: #dc3545; font-weight: 700; }
        #journal-table .lesson-meta strong { font-weight: 700; color: var(--text-color-light); }
        body.dark-mode #journal-table .lesson-meta strong { color: var(--text-color-dark); }
        #journal-table .note-text { white-space: pre-wrap; word-break: break-word; margin-bottom: 8px; font-size: 0.95em; }
        .meta-value { color: var(--success-color); font-weight: 700; }
        .edit-note-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; color: var(--primary-color); }
        
        .toast-container { z-index: 1056; }
        
        #compass-header-links .resource-links a { margin: 0 5px; }
        #compass-header-links .fas { margin-right: 5px; }
        #compass-class-info {
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            border-right: 3px solid var(--primary-color);
            padding-right: 10px;
        }
        body.dark-mode #compass-class-info { color: var(--primary-color); }

        @media print {
            body, .dashboard-container, .main-content { margin: 0 !important; padding: 0 !important; background: white !important; overflow: visible !important; }
            .sidebar, .menu-toggle, .page:not(.active), .page-header, #print-journal-btn, .edit-note-btn, .footer-text { display: none !important; }
            #page-journal, #page-journal .card, .printable-area { display: block !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .printable-area { overflow: hidden !important; }
            .print-title { display: block; text-align: center; font-size: 1.5em; color: black; margin-bottom: 20px; }
            #journal-table { font-size: 11px; width: 100%; table-layout: fixed; border-collapse: collapse; }
            #journal-table th, #journal-table td { border: 1px solid #ccc !important; color: black !important; background-color: white !important; }
            #journal-table th { background-color: #f2f2f2 !important; }
            #journal-table th:nth-child(1), #journal-table td:nth-child(1) { width: 15%; }
            #journal-table th:nth-child(2), #journal-table td:nth-child(2) { width: 50%; }
            #journal-table th:nth-child(3), #journal-table td:nth-child(3) { width: 15%; }
            #journal-table th:nth-child(4), #journal-table td:nth-child(4) { width: 20%; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://i.ibb.co/Z1m0hrnC/icon-512x512.png" alt="شعار التطبيق">
                <h5>بوصلة المسارات</h5>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="#" class="nav-link" data-target="page-stats"><i class="fas fa-chart-pie"></i><span>إحصائيات</span></a></li>
                    <li><a href="#" class="nav-link" data-target="page-compass"><i class="fas fa-compass"></i><span>البوصلة</span></a></li>
                    <li><a href="#" class="nav-link" data-target="page-journal"><i class="fas fa-book-open"></i><span>دفتر النصوص</span></a></li>
                    <li><a href="#" class="nav-link" data-target="page-instructions"><i class="fas fa-info-circle"></i><span>تعليمات الاستخدام</span></a></li>
                    <li><a href="#" class="nav-link" data-target="page-settings"><i class="fas fa-cog"></i><span>الإعدادات</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="darkModeSwitch">
                    <label class="form-check-label" for="darkModeSwitch">الوضع الليلي</label>
                </div>
            </div>
        </aside>
        <div class="sidebar-overlay"></div>

        <main class="main-content">
            <button class="btn menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
            <section id="page-stats" class="page">
                <div class="page-header"><h1>لوحة الإحصائيات</h1><p>هنا تجد نظرة شاملة وتفاعلية على تقدمك، بما في ذلك عدد الأقسام، حالة إنجاز الحصص، وتفاصيل كل قسم على حدة.</p></div>
                <div id="stats-content"></div>
            </section>
            <section id="page-compass" class="page">
                <div class="page-header">
                    <div><h1>البوصلة</h1><p id="compass-subtitle">من هنا يمكنك تصفح محتوى الدروس حسب القسم والأسبوع، وتغيير حالة كل حصة بسهولة لتتبع إنجازك.</p></div>
                    <div id="compass-header-links" class="text-start d-none"></div>
                </div>
                <div id="compass-content"></div>
            </section>
            <section id="page-journal" class="page">
                 <div class="page-header"><h1>دفتر النصوص</h1><p>يعرض هذا القسم سجلاً كاملاً لجميع الحصص التي تم إنجازها، مع إمكانية إضافة ملاحظات وطباعة السجل أو حفظه كملف PDF.</p></div>
                <div class="card">
                     <div class="printable-area">
                        <h2 class="print-title">دفتر النصوص</h2>
                        <table id="journal-table" class="table table-striped table-hover">
                            <thead><tr><th>القسم</th><th class="lesson-topic-cell">موضوع الدرس</th><th>تاريخ الإنجاز</th><th>ملاحظات</th></tr></thead>
                            <tbody id="journal-table-body"></tbody>
                        </table>
                    </div>
                    <div style="text-align: left; margin-top: 1.5rem;"><button id="print-journal-btn" class="btn save-btn">تحميل PDF</button></div>
                </div>
            </section>
            <section id="page-settings" class="page">
                <div class="page-header"><h1>إعدادات الأستاذ</h1><p>هذه هي الخطوة الأولى والأساسية. يرجى تحديد الأقسام التي تدرسها وتخصيص المسار واللبنة المناسبة لكل قسم ليتم عرض المحتوى بشكل صحيح.</p></div>
                <div class="card" id="teacher-settings-container"></div>
            </section>
            <section id="page-instructions" class="page">
                <div class="page-header"><h1>تعليمات الاستخدام</h1><p>دليل شامل ومبسط لمساعدتك على الاستفادة من كل ميزات التطبيق خطوة بخطوة.</p></div>
                <div class="card instructions-content"></div>
            </section>
             <footer class="footer-text">
                <p>© Copyright 2025 Riyapp - All rights reserved.</p>
                <p>Designed with ❤️ by Rachid Outgadirt</p>
            </footer>
        </main>
    </div>

    <!-- Modals -->
    <div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3"></div>
    <div class="modal fade" id="note-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إضافة / تعديل ملاحظة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea id="note-textarea" class="form-control" rows="5" placeholder="اكتب ملاحظاتك هنا..."></textarea></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" id="save-note-btn" class="btn btn-primary">حفظ الملاحظة</button></div></div></div>
    </div>
    <div class="modal fade" id="confirmationModal" tabindex="-1">
         <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title">تم الحفظ بنجاح!</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>تهانينا.. الآن صار بإمكانك الوصول إلى محتوى الأقسام المسندة إليك بسهولة.</p></div><div class="modal-footer border-0"><button type="button" id="confirm-save-ok-btn" class="btn btn-primary">حسناً</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Data objects (data, resourceLinks) are unchanged and placed here...
    const data = { '1': { name: 'الأولى إعدادي', units: ['اللبنة 1', 'اللبنة 2', 'اللبنة 3', 'اللبنة 4', 'اللبنة 5'], paths: { '1': { name: "المسار الأول", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم جملا سردية, ص.7.", "أقرأ بطلاقة وأفهم جملا وصفية لمشهد طبيعي, ص .8.", "أستمع وأفهم جملا سردية من حكاية متخيلة, ص.9.", "أنجز نشاطا توليفيا, ص.10."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم جملا تفسيرية حول ظاهرة اجتماعية, ص. 13.", "أقرأ بطلاقة وأفهم جملا حجاجية في التعبير عن الرأي, ص.14.", "أقرأ بطلاقة وأفهم جملا تفسيرية لحدث, ص. 15.", "أنجز نشاطا توليفيا, ص.16."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم, جملا حجاجية في التعبير عن رأي, ص.19.", "أقرأ بطلاقة وأفهم جملا سردية من حكاية عجيبة, ص.20.", "أنجز نشاطا توليفيا للبنة, ص.23.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص.24."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص. 29.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص.30.", "أستمع وأفهم حكاية مثل, ص.31.", "أنجز نشاطا توليفيا, ص. 32."] }, { name: "الأسبوع الخامس", sessions: ["أقرأ بطلاقة وأفهم فقرة تفسيرية عن ظاهرة طبيعية, ص.35.", "أقرأ بطلاقة وأفهم فقرة حجاجية في التعبير عن رأي, ص.36.", "أقرأ بطلاقة وأفهم فقرة حجاجية في الدفاع عن فكرة, ص.37.", "أنجز نشاطا توليفيا, ص. 38."] }] }, '2': { name: "المسار الثاني", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص.29.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص. 30.", "أستمع وأفهم حكاية مثل, ص.31.", "أنجز نشاطا توليفيا, ص. 32."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم فقرة تفسيرية عن ظاهرة طبيعية, ص.35.", "أقرأ بطلاقة وأفهم فقرة حجاجية في التعبير عن رأي, ص.36.", "أقرأ بطلاقة وأفهم فقرة حجاجية في الدفاع عن فكرة, ص.37.", "أنجز نشاطا توليفيا, ص. 38."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم فقرة عن حكاية عجيبة, ص.41.", "أقرأ بطلاقة وأفهم فقرة حجاجية في التعبير عن موقف, ص. 42.", "أنجز نشاطا توليفيا للبنة, ص. 45 و 46.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 47 - 48."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص.52.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.53.", "أستمع وأفهم نصا سرديا من حكاية عجيبة, ص.54.", "أنجز نشاطا توليفيا, ص.55."] }, { name: "الأسبوع الخامس", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا حول ظاهرة اجتماعية, ص. 58.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص. 59.", "أقرأ بطلاقة وأفهم نصا تفسيريا عن حدث ثقافي, ص.60.", "أنجز نشاطا توليفيا, ص.61."] }] }, '3': { name: "المسار الثالث", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص.52.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.53.", "أستمع وأفهم نصا سرديا من حكاية عجيبة, ص.54.", "أنجز نشاطا توليفيا, ص.55."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا حول ظاهرة اجتماعية, ص. 58.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص.59.", "أقرأ بطلاقة وأفهم نصا تفسيريا عن حدث ثقافي, ص.60.", "أنجز نشاطا توليف, ص.61."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا وصفيا في وصف الشخوص, ص. 64.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.65.", "أنجز نشاطا توليفيا للبنة, ص 68-69.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 70-71."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.75.", "أقرأ بطلاقة وأفهم نصا وصفيا في وصف المشاعر, ص.76.", "أستمع وأفهم نصا سرديا عن حكاية واقعية, ص.77.", "أنجز نشاطا توليفيا, ص. 78."] }, { name: "الأسبوع الخامس", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.81.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.82.", "أقرأ بطلاقة وأفهم نصا تفسيريا عن حدث ثقافي, ص.83.", "أنجز نشاطا توليفيا, ص.84."] }] }, '4': { name: "المسار الرابع", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.75.", "أقرأ بطلاقة وأفهم نصا وصفيا في وصف المشاعر, ص.76.", "أستمع وأفهم نصا سرديا عن حكاية واقعية, ص.77.", "أنجز نشاطا توليفيا, ص. 78."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.81.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.82.", "أقرأ بطلاقة وأفهم نصا تفسيريا عن حدث ثقافي, ص.83.", "أنجز نشاطا توليفيا, ص.84."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا حجاجيا في التعبير عن موقف, ص.87.", "أقرأ بطلاقة وأفهم نصا سرديا حول قصة متخيلة, ص.88.", "أنجز نشاطا توليفيا للبنة, ص.91 و92.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 93 و94."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا في السيرة الغيرية, ص. 98.", "أقرأ بطلاقة وأفهم نصا في وصف الشخوص والمشاعر, ص. 100.", "أستمع وأفهم نصا تفسيريا لحدث علمي, ص.102.", "أنجز نشاطا توليفيا, ص. 103-104."] }, { name: "الأسبوع الخامس", sessions: ["أقرأ بطلاقة وأفهم نصا حجاجيا عن ظاهرة فكرية, ص.109 و110.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص. 111 و112.", "أقرأ بطلاقة وأفهم نصا سرديا عن السيرة الذاتية, ص.113-114.", "أنجز نشاطا توليفيا للبنة, ص.118."] }] } } }, '2': { name: 'الثانية إعدادي', units: ['اللبنة 1', 'اللبنة 2', 'اللبنة 3', 'اللبنة 4', 'اللبنة 5'], paths: { '1': { name: "المسار الأول", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم, جملا سردية, ص.6.", "أقرأ بطلاقة وأفهم جملا وصفية لمشهد طبيعي, ص .7.", "أستمع وأفهم جملا سردية, ص.8.", "أنجز نشاطا توليفيا, ص.9."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم, جملا تفسيرية حول ظاهرة اجتماعية, ص.12.", "أقرأ بطلاقة وأفهم جملا حجاجية في التعبير عن الرأي, ص.13.", "أقرأ بطلاقة وأفهم جملا تفسيرية لحدث واقعي, ص.14.", "أنجز نشاطا توليفيا, ص.15."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم جملا حجاجية في التعبير عن رأي, ص.18.", "أقرأ بطلاقة وأفهم جملا سردية في حكاية عجيبة, ص.19.", "أنجز نشاطا توليفيا للبنة, ص.22.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 23-24."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص. 26.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص.27.", "أستمع وأفهم حكاية مثل, ص.28.", "أنجز نشاطا توليفيا, ص. 29."] }] }, '2': { name: "المسار الثاني", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص. 26.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص.27.", "أستمع وأفهم حكاية مثل, ص.28.", "أنجز نشاطا توليفيا, ص. 29."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم فقرة تفسيرية عن ظاهرة طبيعية, ص. 32.", "أقرأ بطلاقة وأفهم فقرة حجاجية في التعبير عن رأي, ص.33.", "أنجز نشاطا توليفيا للبنة, ص. 36-37.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 38-39."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص. 41.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.42.", "أستمع وأفهم نصا سرديا لحكاية عجيبة, ص.43.", "أنجز نشاطا توليفيا, ص.44."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم تفسيريا حول ظاهرة اجتماعية, ص.47.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص.48.", "أنجز نشاطا توليفيا للبنة, ص. 51-52.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 53-54."] }] }, '3': { name: "المسار الثالث", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص. 41.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.42.", "أستمع وأفهم نصا سرديا لحكاية عجيبة, ص.43.", "أنجز نشاطا توليفيا, ص.44."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم تفسيريا حول ظاهرة اجتماعية, ص.47.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص.48.", "أنجز نشاطا توليفيا للبنة, ص. 51-52.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 53-54."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.56.", "أقرأ وأفهم نصا وصفيا في وصف المشاعر, ص.57.", "أستمع وأفهم نصا سرديا لحكاية واقعية, ص.58.", "أنجز نشاطا توليفيا, ص.59."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.62.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.63.", "أنجز نشاطا توليفيا للبنة, ص.66-67.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 68-69."] }] }, '4': { name: "المسار الرابع", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.56.", "أقرأ وأفهم نصا وصفيا في وصف المشاعر, ص.57.", "أستمع وأفهم نصا سرديا لحكاية واقعية, ص.58.", "أنجز نشاطا توليفيا, ص.59."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.62.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.63.", "أنجز نشاطا توليفيا للبنة, ص.66-67.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 68-69."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا في السيرة الذاتية, ص. 71.", "أقرأ بطلاقة وأفهم نصا في وصف الشخوص والمشاعر, ص. 72.", "أنجز نشاطا توليفيا, ص.73.", "أقرأ بطلاقة وأفهم نصا حجاجيا عن ظاهرة فكرية, ص.76."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن السيرة الذاتية, ص.77.", "أنجز نشاطا توليفيا للبنة, ص 79.", "أنجز نشاطا توليفيا للبنة, ص 80.", "نشاط ختامي."] }] } } }, '3': { name: 'الثالثة إعدادي', units: ['اللبنة 1', 'اللبنة 2', 'اللبنة 3', 'اللبنة 4', 'اللبنة 5'], paths: { '1': { name: "المسار الأول", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم, جملا سردية, ص.6.", "أقرأ بطلاقة وأفهم جملا وصفية لمشهد طبيعي, ص.7.", "أستمع وأفهم جملا سردية من حكاية متخيلة, ص.8.", "أنجز نشاطا توليفيا, ص.9."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم, جملا تفسيرية حول ظاهرة اجتماعية, ص.12.", "أقرأ بطلاقة وأفهم جملا حجاجية في التعبير عن الرأي, ص.13.", "أقرأ بطلاقة وأفهم جملا تفسيرية لحدث واقعي, ص.14.", "أنجز نشاطا توليفيا, ص.15."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم جملا حجاجية في التعبير عن رأي, ص.18.", "أقرأ بطلاقة وأفهم جملا سردية في حكاية عجيبة, ص.19.", "أنجز نشاطا توليفيا للبنة, ص.22.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 23-24."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص. 26.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص.27.", "أستمع وأفهم حكاية مثل, ص.28.", "أنجز نشاطا توليفيا, ص. 29."] }] }, '2': { name: "المسار الثاني", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم فقرة سردية من حكاية متخيلة, ص. 26.", "أقرأ بطلاقة وأفهم فقرة وصفية لمشهد طبيعي, ص.27.", "أستمع وأفهم حكاية مثل, ص.28.", "أنجز نشاطا توليفيا, ص. 29."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم فقرة تفسيرية عن ظاهرة طبيعية, ص. 32.", "أقرأ بطلاقة وأفهم فقرة حجاجية في التعبير عن رأي, ص.33.", "أنجز نشاطا توليفيا للبنة, ص. 36-37.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 38-39."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص. 41.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.42.", "أستمع وأفهم نصا سرديا لحكاية عجيبة, ص.43.", "أنجز نشاطا توليفيا, ص.44."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم تفسيريا حول ظاهرة اجتماعية, ص.47.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص. 48.", "أنجز نشاطا توليفيا للبنة, ص. 51-52.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 53-54."] }] }, '3': { name: "المسار الثالث", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن حكاية متخيلة, ص. 41.", "أقرأ بطلاقة وأفهم نصا في وصف مكان, ص.42.", "أستمع وأفهم نصا سرديا لحكاية عجيبة, ص.43.", "أنجز نشاطا توليفيا, ص.44."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم تفسيريا حول ظاهرة اجتماعية, ص. 47.", "أقرأ بطلاقة وأفهم نصا حجاجيا في الدفاع عن موقف, ص. 48.", "أنجز نشاطا توليفيا للبنة, ص. 51-52.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 53-54."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.56.", "أقرأ وأفهم نصا وصفيا في وصف المشاعر, ص.57.", "أستمع وأفهم نصا سرديا لحكاية واقعية, ص.58.", "أنجز نشاطا توليفيا, ص.59."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.62.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.63.", "أنجز نشاطا توليفيا للبنة, ص.66-67.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 68-69."] }] }, '4': { name: "المسار الرابع", weeks: [{ name: "الأسبوع الأول", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا لقصة مثل, ص.56.", "أقرأ وأفهم نصا وصفيا في وصف المشاعر, ص.57.", "أستمع وأفهم نصا سرديا لحكاية واقعية, ص.58.", "أنجز نشاطا توليفيا, ص.59."] }, { name: "الأسبوع الثاني", sessions: ["أقرأ بطلاقة وأفهم نصا تفسيريا لظاهرة اجتماعية, ص.62.", "أقرأ بطلاقة وأفهم نصا حجاجيا في التعقيب عن رأي, ص.63.", "أنجز نشاطا توليفيا للبنة, ص.66-67.", "اجتياز الرائز لأقوم درجة تحكمي في اللبنة, ص. 68-69."] }, { name: "الأسبوع الثالث", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا في السيرة الذاتية, ص. 71.", "أقرأ بطلاقة وأفهم نصا في وصف الشخوص والمشاعر, ص. 72.", "أنجز نشاطا توليفيا, ص.73.", "أقرأ بطلاقة وأفهم نصا حجاجيا عن ظاهرة فكرية, ص.76."] }, { name: "الأسبوع الرابع", sessions: ["أقرأ بطلاقة وأفهم نصا سرديا عن السيرة الذاتية, ص.77.", "أنجز نشاطا توليفيا للبنة, ص 79.", "أنجز نشاطا توليفيا للبنة, ص 80.", "نشاط ختامي."] }] } } } };
    const resourceLinks = { '1': { '1': { path: 'https://drive.google.com/drive/folders/1PA25uD6vcZGvRhkNIp4g4qb5CDl4cdhG', booklet: 'https://drive.google.com/file/d/1aWGPkhCAVO8TPJy0I2aqI6KPP6XcCB1c/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '2': { path: 'https://drive.google.com/drive/folders/1XIyFZY30ZlelJ81Fwgl-a4SIqmBaJBUN', booklet: 'https://drive.google.com/file/d/1v5vvifoOT_pOyd0qK9UkgwUeg1UikBXy/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '3': { path: 'https://drive.google.com/drive/folders/1HgEsjqlUZDum_xql0WsnWL593oP8tpNn', booklet: 'https://drive.google.com/file/d/1JoF2IC023chzmfHsDN6_gl0lZy0RrDB2/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '4': { path: 'https://drive.google.com/drive/folders/1GQG0X2N_kEmWEdoIyrKS5t0lGJWhOtia', booklet: 'https://drive.google.com/file/d/1AGRqldBdMw1OF9EmeIMPu2yvze10kXmO/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' } }, '2': { '1': { path: 'https://drive.google.com/drive/folders/1dH0pWLSPWTnvHls1EWvR_kNk_d0gQRSm', booklet: 'https://drive.google.com/file/d/1Qm4bayuzdIs8Dtz5hkqycdmpouYrPVIV/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '2': { path: 'https://drive.google.com/drive/folders/1D3SJjwe0hWFP5aE7oh0ZwwrgkoM7G-by', booklet: 'https://drive.google.com/file/d/1WNz1QCq4gc595_3p-1G6QmR3SBTzE3gv/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '3': { path: 'https://drive.google.com/drive/folders/1gLp4LFvrWduF9AxzzKU0D37RA88dhty3', booklet: 'https://drive.google.com/file/d/1AQpIigiLg0OAP0opzJvUfo1RZ4jgRiTb/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '4': { path: 'https://drive.google.com/drive/folders/1y03XOMsd7xdcuqOtyZ0FH7ZZMhErNsT2', booklet: 'https://drive.google.com/file/d/14SKYTsbFRSilWxf7AOj9-wEza1FUgoNV/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' } }, '3': { '1': { path: 'https://drive.google.com/drive/folders/13pka0l5DNFUGUhRINc1KRMqXCeYd7rFK', booklet: 'https://drive.google.com/file/d/1Wyd1D1UFwrbNSMbU2HK3VN0wfaH2XAfl/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '2': { path: 'https://drive.google.com/drive/folders/1XlZ-HqAp7NiCmZfEsL5O4X3DeFvxXSrb', booklet: 'https://drive.google.com/file/d/1jgVZK7CiT7dC4_D6hgdmYjH7c88Q6EA7/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '3': { path: 'https://drive.google.com/drive/folders/1oY_gj1LGtourOiqguX5z2Y9BFz9aIcfQ', booklet: 'https://drive.google.com/file/d/1FmyZm9q83YfzK7wpVKPPiVP2R1fJ0ysM/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' }, '4': { path: 'https://drive.google.com/drive/folders/1QGCG-hZYJ-QompSgoGLhOrERDeqXeMPg', booklet: 'https://drive.google.com/file/d/1cMUD0g5XnLF4wLS1wyS0SV6lRth9lwbD/view?usp=sharing', audio: 'https://drive.google.com/file/d/1FGqsq70icv2fOrL7FA6ekQCdwORCFo9V/view?usp=sharing' } } };

    (function() {
        
        let lessonChart = null;
        let noteModalInstance;
        let confirmationModalInstance;
        const lessonStatuses = { pending: { text: 'غير منجزة', class: 'pending', next: 'incomplete' }, incomplete: { text: 'غير مكتملة', class: 'incomplete', next: 'done' }, done: { text: 'منجزة', class: 'done', next: 'pending' } };
        
        const getDb = (key) => JSON.parse(localStorage.getItem(key) || '{}');
        const setDb = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const showToast = (message) => {
            const toastContainer = document.querySelector('.toast-container') || document.createElement('div');
            if(!toastContainer.classList.contains('toast-container')) {
                toastContainer.className = 'toast-container position-fixed bottom-0 start-50 translate-middle-x p-3';
                document.body.appendChild(toastContainer);
            }
            const toastId = 'toast' + Date.now();
            const toastHTML = `<div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="me-auto">تنبيه</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body">${message}</div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        };
        const getTodayDate = () => new Date().toISOString().slice(0, 10);
        
        const switchPage = (targetId) => {
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === targetId));
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('show')) sidebar.classList.remove('show');
            if (targetId === 'page-stats') renderStatisticsPage();
            if (targetId === 'page-journal') renderJournal();
            if (targetId === 'page-compass') checkCompassPrerequisites();
            if (targetId === 'page-settings') renderSettingsPage();
        };

        const renderStatisticsPage = () => {
            const statsContent = document.getElementById('stats-content');
            const settings = getDb('teacherSettings');
            if (Object.keys(settings).length === 0) {
                statsContent.innerHTML = `<div class="alert alert-info">يرجى الانتقال إلى صفحة "الإعدادات" أولاً لتحديد الأقسام والمسارات.</div>`;
                return;
            }
            const overallStats = getStatsData();
            let classDetailsHTML = '';
            let classOptionsHTML = '<option value="all">كل الأقسام</option>';
            Object.entries(settings).forEach(([classId, classInfo]) => {
                 const pathName = data[classInfo.levelId]?.paths[classInfo.unitId]?.name || 'N/A';
                 const unitName = data[classInfo.levelId]?.units[classInfo.unitId-1] || 'N/A';
                 classDetailsHTML += `<div class="col-md-4 mb-3"><div class="card h-100"><div class="card-body"><h4>${classInfo.className}</h4><p class="mb-0"><strong>المسار:</strong> ${pathName} - ${unitName}</p></div></div></div>`;
                classOptionsHTML += `<option value="${classId}">${classInfo.className}</option>`;
            });
            statsContent.innerHTML = `
                <div class="stats-grid">
                    <div class="card stat-card"><div class="card-body"><div class="value">${Object.keys(settings).length}</div><div class="label">الأقسام المسندة</div></div></div>
                    <div class="card stat-card"><div class="card-body"><div class="value" style="color:var(--success-color)">${overallStats.done}</div><div class="label">حصص منجزة</div></div></div>
                    <div class="card stat-card"><div class="card-body"><div class="value" style="color:var(--incomplete-color)">${overallStats.incomplete}</div><div class="label">غير مكتملة</div></div></div>
                    <div class="card stat-card"><div class="card-body"><div class="value" style="color:var(--pending-color)">${overallStats.pending}</div><div class="label">غير منجزة</div></div></div>
                </div>
                <div class="card"><h3>نظرة عامة على الأقسام</h3><div class="row">${classDetailsHTML}</div></div>
                <div class="card">
                    <div class="control-group"><div><label for="stats-class-select">عرض إحصائيات القسم:</label><select id="stats-class-select" class="form-select">${classOptionsHTML}</select></div></div>
                    <div style="max-height: 400px; position: relative;"><canvas id="lesson-chart"></canvas></div>
                </div>`;
            updateChart('all');
            document.getElementById('stats-class-select').addEventListener('change', (e) => updateChart(e.target.value));
        };
        
        const updateChart = (classId) => {
            const stats = getStatsData(classId);
            const ctx = document.getElementById('lesson-chart')?.getContext('2d');
            if (!ctx) return;
            const isDark = document.body.classList.contains('dark-mode');
            const chartData = {
                labels: ['منجزة', 'غير مكتملة', 'غير منجزة'],
                datasets: [{
                    label: 'حالة الحصص',
                    data: [stats.done, stats.incomplete, stats.pending],
                    backgroundColor: [ 'rgba(46, 204, 113, 0.7)', 'rgba(52, 152, 219, 0.7)', 'rgba(230, 126, 34, 0.7)' ],
                    borderColor: [ '#2ecc71', '#3498db', '#e67e22' ],
                    borderWidth: 1
                }]
            };
            if (lessonChart) lessonChart.destroy();
            lessonChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: isDark ? 'white' : '#666' } }
                    }
                }
            });
        };
        
        const getStatsData = (classIdFilter = 'all') => {
            const tracker = getDb('lessonTracker');
            const settings = getDb('teacherSettings');
            const counts = { done: 0, incomplete: 0, pending: 0, total: 0 };
            Object.keys(settings).forEach(classId => {
                if (classIdFilter !== 'all' && classId !== classIdFilter) return;
                const classInfo = settings[classId];
                const pathData = data[classInfo.levelId]?.paths[classInfo.unitId];
                if (!pathData) return;
                pathData.weeks.forEach((week, weekIdx) => {
                    week.sessions.forEach((session, sessionIdx) => {
                        counts.total++;
                        const lessonId = `${classId}-${weekIdx}-${sessionIdx}`;
                        const status = tracker[lessonId]?.status || 'pending';
                        counts[status]++;
                    });
                });
            });
            return counts;
        };

        const renderJournal = () => {
            const tableBody = document.getElementById('journal-table-body');
            const tracker = getDb('lessonTracker');
            const settings = getDb('teacherSettings');
            tableBody.innerHTML = '';
            const doneLessons = Object.entries(tracker).filter(([,d]) => d.status === 'done').map(([id, d]) => ({id, ...d}));
            doneLessons.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
            if(doneLessons.length === 0){
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center">لا توجد حصص منجزة لعرضها في دفتر النصوص بعد.</td></tr>`;
                return;
            }
            doneLessons.forEach(({id, date, note}) => {
                const parts = id.split('-');
                if (parts.length < 4) return;
                const classId = `${parts[0]}-${parts[1]}`;
                const weekIdx = parts[2];
                const sessionIdx = parts[3];
                const classInfo = settings[classId];
                if (!classInfo) return; 
                const pathData = data[classInfo.levelId]?.paths[classInfo.unitId];
                if (!pathData) return;
                const sessionContent = pathData.weeks[weekIdx]?.sessions[sessionIdx] || 'درس غير محدد';
                const noteText = note || '';
                const row = `<tr><td>${classInfo.className}</td><td class="lesson-topic-cell"><div class="lesson-title">${sessionContent}</div><div class="lesson-meta"><strong>المسار:</strong> <span class="meta-value">${classInfo.unitId}</span> | <strong>اللبنة:</strong> <span class="meta-value">${classInfo.unitId}</span> | <strong>الأسبوع:</strong> <span class="meta-value">${parseInt(weekIdx) + 1}</span> | <strong>الحصة:</strong> <span class="meta-value">${parseInt(sessionIdx) + 1}</span></div></td><td>${date || 'غير محدد'}</td><td><div class="note-text">${noteText}</div><button class="edit-note-btn" data-lesson-id="${id}" title="إضافة/تعديل ملاحظة"><i class="fas fa-edit"></i></button></td></tr>`;
                tableBody.innerHTML += row;
            });
        };

        const openNoteModal = (lessonId) => {
            const tracker = getDb('lessonTracker');
            const note = tracker[lessonId]?.note || '';
            document.getElementById('note-textarea').value = note;
            document.getElementById('save-note-btn').dataset.lessonId = lessonId;
            noteModalInstance.show();
        };

        const saveNote = () => {
            const btn = document.getElementById('save-note-btn');
            const { lessonId } = btn.dataset;
            if (!lessonId) return;
            const tracker = getDb('lessonTracker');
            tracker[lessonId] = tracker[lessonId] || {};
            tracker[lessonId].note = document.getElementById('note-textarea').value;
            setDb('lessonTracker', tracker);
            noteModalInstance.hide();
            showToast('تم حفظ الملاحظة.');
            renderJournal();
        };
        
        const setupTeacherSettings = () => {
            const nav = document.getElementById('settings-tabs-nav');
            const content = document.getElementById('settings-tabs-content');
            if (!nav || !content) return;
            nav.innerHTML = ''; content.innerHTML = '';
            // === FINAL FIX: Ensure first tab is active by default ===
            Object.entries(data).forEach(([levelId, levelData], index) => {
                const isActive = index === 0;
                nav.innerHTML += `<li class="nav-item" role="presentation"><button class="nav-link ${isActive ? 'active' : ''}" id="tab-btn-${levelId}" data-bs-toggle="tab" data-bs-target="#level-tab-${levelId}" type="button" role="tab" aria-controls="level-tab-${levelId}" aria-selected="${isActive}">${levelData.name}</button></li>`;
                
                let classCheckboxes = Array.from({length: 16}, (_, i) => {
                    const classId = `${levelId}-${i+1}`;
                    const className = `${levelData.name.split(' ')[0]} ${i+1}`;
                    return `<div class="class-checkbox-item form-check"><input class="form-check-input" type="checkbox" id="${classId}" value="${classId}" data-class-name="${className}" data-level-id="${levelId}"><label class="form-check-label" for="${classId}">${className}</label></div>`;
                }).join('');

                content.innerHTML += `<div class="tab-pane fade ${isActive ? 'show active' : ''}" id="level-tab-${levelId}" role="tabpanel" aria-labelledby="tab-btn-${levelId}"><div class="p-3"><h5 class="mb-3">الخطوة 1: تحديد الأقسام المسندة للمستوى</h5><div class="class-selection-grid">${classCheckboxes}</div><hr class="my-4"><h5 class="mb-3">الخطوة 2: تخصيص اللبنة لكل قسم</h5><div class="assignments-container" id="assignments-container-${levelId}"></div></div></div>`;
            });

            content.addEventListener('change', e => { if(e.target.matches('.class-selection-grid input[type="checkbox"]')) { updateAssignmentColumns(e.target); } });
        };
        
        const updateAssignmentColumns = (checkbox) => {
             const { value: classId, dataset: { levelId, className } } = checkbox;
            const container = document.getElementById(`assignments-container-${levelId}`);
            if(!container) return;

            if (checkbox.checked) {
                if (container.querySelector(`div[data-class-id="${classId}"]`)) return;
                const savedSettings = getDb('teacherSettings')[classId] || {};
                const unitOptions = data[levelId].units.map((unit, i) => `<option value="${i+1}" ${(i+1) == savedSettings.unitId ? 'selected' : ''}>${unit}</option>`).join('');
                const column = document.createElement('div');
                column.className = 'assignment-column card';
                column.dataset.classId = classId;
                column.innerHTML = `<h5 class="card-header">${className}</h5><div class="card-body"><select class="unit-select form-select"><option value="">-- اختر اللبنة --</option>${unitOptions}</select></div>`;
                container.appendChild(column);
            } else {
                const columnToRemove = container.querySelector(`div[data-class-id="${classId}"]`);
                if (columnToRemove) columnToRemove.remove();
            }
        };

        const loadTeacherSettings = () => {
             const settings = getDb('teacherSettings');
            if (Object.keys(settings).length === 0) return;
            Object.keys(settings).forEach(classId => {
                const checkbox = document.getElementById(classId);
                if (checkbox) {
                    checkbox.checked = true;
                    updateAssignmentColumns(checkbox);
                }
            });
        };
        
        const updateUIAfterSettingsChange = () => {
            checkCompassPrerequisites();
            if (document.getElementById('page-stats').classList.contains('active')) {
                renderStatisticsPage();
            }
        };
        
        const saveTeacherSettings = () => {
            let settings = getDb('teacherSettings');
            const allCheckboxes = document.querySelectorAll('.class-selection-grid input[type="checkbox"]');
            
            allCheckboxes.forEach(checkbox => {
                const classId = checkbox.value;
                const { levelId, className } = checkbox.dataset;
        
                if (checkbox.checked) {
                    const column = document.querySelector(`.assignment-column[data-class-id="${classId}"]`);
                    if (column) {
                        const unitId = column.querySelector('.unit-select').value;
                        if (unitId) {
                            settings[classId] = { unitId, levelId, className };
                        } else {
                           if (settings[classId]) delete settings[classId];
                        }
                    }
                } else {
                    if (settings[classId]) delete settings[classId];
                }
            });
        
            setDb('teacherSettings', settings);
            updateUIAfterSettingsChange();
            confirmationModalInstance.show();
        };

        const renderSettingsPage = () => {
            const settingsContainer = document.getElementById('teacher-settings-container');
            if(settingsContainer.querySelector('#settings-content')) return; // Don't re-render if already exists

            settingsContainer.innerHTML = `
                <div id="settings-content">
                    <ul class="nav nav-tabs" id="settings-tabs-nav" role="tablist"></ul>
                    <div class="tab-content border border-top-0 rounded-bottom" id="settings-tabs-content"></div>
                    <div class="mt-4 d-flex justify-content-end">
                        <button id="save-teacher-settings" class="btn save-btn">حفظ كل الإعدادات</button>
                    </div>
                </div>`;
            setupTeacherSettings();
            loadTeacherSettings();
        };

        const renderInstructionsPage = () => {
             document.querySelector('.instructions-content').innerHTML = `
                <ul>
                    <li><strong>الخطوة الأولى: إعدادات الأستاذ</strong>
                        <ul>
                            <li>اذهب إلى تبويب "الإعدادات" من القائمة الجانبية.</li>
                            <li>افتح تبويب المستوى الدراسي الذي تدرّسه (الأولى, الثانية, أو الثالثة إعدادي).</li>
                            <li><strong>حدد الأقسام:</strong> قم باختيار كل الأقسام المسندة إليك.</li>
                            <li><strong>خصص اللبنة:</strong> لكل قسم يظهر أمامك, اختر "اللبنة" المناسبة له من القائمة المنسدلة أسفله.</li>
                            <li><strong>حفظ الإعدادات:</strong> بعد الانتهاء، انقر على زر "حفظ كل الإعدادات".</li>
                        </ul>
                    </li>
                    <li><strong>الخطوة الثانية: استعراض وتتبع الحصص (البوصلة)</strong>
                        <ul>
                            <li>اذهب إلى تبويب "البوصلة". بعد الحفظ, سيظهر لك عرض المحتوى مباشرة.</li>
                            <li>استخدم الفلاتر في الأعلى لاختيار القسم، والأسبوع، أو حصة معينة.</li>
                            <li><strong>تغيير حالة الحصة:</strong> انقر على حالة الحصة لتغييرها. الحالات تتغير بالترتيب التالي: <strong>غير منجزة > غير مكتملة > منجزة</strong>.</li>
                            <li>عند اختيار "منجزة"، سيظهر حقل لاختيار تاريخ الإنجاز.</li>
                        </ul>
                    </li>
                     <li><strong>الخطوة الثالثة: دفتر النصوص</strong>
                        <ul>
                            <li>اذهب إلى تبويب "دفتر النصوص" لعرض كل الحصص المنجزة.</li>
                            <li>يمكنك إضافة ملاحظات لكل حصة منجزة وطباعة الدفter أو حفظه كملف PDF.</li>
                        </ul>
                    </li>
                     <li><strong>الخطوة الرابعة: الإحصائيات</strong>
                        <ul>
                            <li>اذهب إلى تبويب "إحصائيات" لرؤية ملخص شامل لتقدمك، ورسوم بيانية توضح حالة إنجاز الحصص.</li>
                        </ul>
                    </li>
                </ul>`;
        };
        
        const checkCompassPrerequisites = () => {
            const compassContent = document.getElementById('compass-content');
            const settings = getDb('teacherSettings');
            if (Object.keys(settings).length === 0) {
                compassContent.innerHTML = `<div class="alert alert-info">لعرض محتوى البوصلة، يرجى الانتقال إلى صفحة "الإعدادات" أولاً لتحديد الأقسام والمسارات.</div>`;
                document.getElementById('compass-subtitle').textContent = "يرجى إتمام الإعدادات أولاً.";
                document.getElementById('compass-header-links').classList.add('d-none');
            } else {
                compassContent.innerHTML = `<div class="card"><div class="control-group"><div class="flex-grow-1"><label for="class-select">اختر القسم:</label><select id="class-select" class="form-select"></select></div><div><label for="week-select">اختر الأسبوع:</label><select id="week-select" class="form-select"></select></div><div><label for="session-select">اختر الحصة:</label><select id="session-select" class="form-select"></select></div></div></div><div id="content-display"></div>`;
                populateMainClassSelector();
                addDynamicEventListeners();
                loadLastView();
            }
        };

        const loadLastView = () => {
             const lastView = getDb('lastView');
             const classSelect = document.getElementById('class-select');
             if (lastView.classId && classSelect && Array.from(classSelect.options).some(opt => opt.value === lastView.classId)) {
                classSelect.value = lastView.classId;
                updateFilterOptions();
                document.getElementById('week-select').value = lastView.weekIndex;
                document.getElementById('session-select').value = lastView.sessionIndex;
                displayContent();
             } else if (classSelect && classSelect.options.length > 1) {
                classSelect.selectedIndex = 1;
                updateFilterOptions();
                displayContent();
             } else {
                updateCompassHeader();
             }
        };

        const addGlobalEventListeners = () => {
            document.body.addEventListener('click', (e) => {
                if(e.target.matches('#save-teacher-settings')) saveTeacherSettings();
                if(e.target.matches('#print-journal-btn')) window.print();
                if(e.target.matches('.edit-note-btn') || e.target.closest('.edit-note-btn')) {
                    const btn = e.target.closest('.edit-note-btn');
                    openNoteModal(btn.dataset.lessonId);
                }
                if(e.target.matches('#save-note-btn')) saveNote();
            });
             document.getElementById('confirm-save-ok-btn').addEventListener('click', () => {
                confirmationModalInstance.hide();
                switchPage('page-compass');
            });
            document.querySelector('.sidebar-overlay').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('show');
            });
        };
        
        const addDynamicEventListeners = () => {
            const compassContent = document.getElementById('compass-content');
            if (!compassContent) return;
            compassContent.addEventListener('click', e => { if (e.target.classList.contains('status-toggle')) { handleStatusToggle(e.target); } });
            compassContent.addEventListener('change', e => {
                if (e.target.classList.contains('completion-date')) { saveCompletionDate(e.target); }
                else if (e.target.matches('#class-select')) { updateFilterOptions(); displayContent(); }
                else if (e.target.matches('#week-select, #session-select')) { displayContent(); }
            });
        };
        
        const populateMainClassSelector = () => {
            const classSelect = document.getElementById('class-select');
            if (!classSelect) return;
            const settings = getDb('teacherSettings');
            classSelect.innerHTML = '<option value="">-- اختر القسم --</option>';
            Object.entries(settings).forEach(([classId, classInfo]) => {
                classSelect.innerHTML += `<option value="${classId}">${classInfo.className}</option>`;
            });
        };

        const updateFilterOptions = () => {
            const classSelect = document.getElementById('class-select');
            const weekSelect = document.getElementById('week-select');
            const sessionSelect = document.getElementById('session-select');
            if (!classSelect || !weekSelect || !sessionSelect) return;
        
            const classId = classSelect.value;
            const settings = getDb('teacherSettings');
        
            weekSelect.innerHTML = '<option value="all">كل الأسابيع</option>';
            sessionSelect.innerHTML = '<option value="all">كل الحصص</option>';
            sessionSelect.innerHTML += ['الأولى', 'الثانية', 'الثالثة', 'الرابعة'].map((s, i) => `<option value="${i}">الحصة ${s}</option>`).join('');

            if (classId && settings[classId]) {
                const { levelId, unitId } = settings[classId];
                const pathData = data[levelId]?.paths[unitId];
                if (pathData) {
                    pathData.weeks.forEach((week, index) => {
                        weekSelect.innerHTML += `<option value="${index}">${week.name}</option>`;
                    });
                }
            }
        };

        const displayContent = () => {
            const contentDisplay = document.getElementById('content-display');
            const classSelect = document.getElementById('class-select');
            const weekSelect = document.getElementById('week-select');
            const sessionSelect = document.getElementById('session-select');
            if (!contentDisplay || !classSelect || !weekSelect || !sessionSelect) return;
        
            const classId = classSelect.value;
            const selectedWeek = weekSelect.value;
            const selectedSession = sessionSelect.value;
            const settings = getDb('teacherSettings');
            const tracker = getDb('lessonTracker');
        
            contentDisplay.innerHTML = '';
            if (!classId) {
                contentDisplay.innerHTML = `<div class="alert alert-secondary">يرجى اختيار قسم لعرض المحتوى.</div>`;
                updateCompassHeader();
                return;
            }
        
            const { levelId, unitId } = settings[classId];
            const pathData = data[levelId]?.paths[unitId];
            if (!pathData) return;
        
            let contentHTML = '';
            pathData.weeks.forEach((week, weekIdx) => {
                if (selectedWeek !== 'all' && parseInt(selectedWeek) !== weekIdx) return;
                
                let weekSessionsHTML = '';
                let hasVisibleSessions = false;
                week.sessions.forEach((session, sessionIdx) => {
                    if (selectedSession !== 'all' && parseInt(selectedSession) !== sessionIdx) return;
                    
                    hasVisibleSessions = true;
                    const lessonId = `${classId}-${weekIdx}-${sessionIdx}`;
                    const lessonData = tracker[lessonId] || {};
                    const status = lessonData.status || 'pending';
                    const statusInfo = lessonStatuses[status];
                    const dateValue = lessonData.date || getTodayDate();
        
                    weekSessionsHTML += `
                        <div class="card session-card">
                            <div class="card-header session-card-header d-flex">
                                <h6 class="mb-0"><strong>الحصة ${sessionIdx + 1}</strong></h6>
                                <div class="status-toggle ${statusInfo.class}" data-lesson-id="${lessonId}">${statusInfo.text}</div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${session}</p>
                            </div>
                            <div class="card-footer completion-date-container ${status === 'done' ? '' : 'd-none'}">
                                <label for="date-${lessonId}" class="me-2">تاريخ الإنجاز:</label>
                                <input type="date" id="date-${lessonId}" class="form-control form-control-sm completion-date" value="${dateValue}" data-lesson-id="${lessonId}">
                            </div>
                        </div>`;
                });

                if(hasVisibleSessions){
                     contentHTML += `
                        <div class="week-block">
                            <h4 class="week-title">${week.name}</h4>
                            <div class="session-grid">${weekSessionsHTML}</div>
                        </div>`;
                }
            });

            contentDisplay.innerHTML = contentHTML || '<div class="alert alert-secondary">لا توجد حصص تطابق هذا الفلتر.</div>';

            setDb('lastView', { classId, weekIndex: selectedWeek, sessionIndex: selectedSession });
            updateCompassHeader();
        };

        const handleStatusToggle = (target) => {
            const { lessonId } = target.dataset;
            const tracker = getDb('lessonTracker');
            const currentStatus = tracker[lessonId]?.status || 'pending';
            const nextStatus = lessonStatuses[currentStatus].next;
        
            tracker[lessonId] = tracker[lessonId] || {};
            tracker[lessonId].status = nextStatus;
        
            if (nextStatus === 'done' && !tracker[lessonId].date) {
                tracker[lessonId].date = getTodayDate();
            } else if (nextStatus !== 'done') {
                delete tracker[lessonId].date;
            }
        
            setDb('lessonTracker', tracker);
            displayContent();
            if(document.getElementById('page-journal').classList.contains('active')) renderJournal();
        };

        const saveCompletionDate = (target) => {
            const { lessonId } = target.dataset;
            const tracker = getDb('lessonTracker');
            if (tracker[lessonId]) {
                tracker[lessonId].date = target.value;
                setDb('lessonTracker', tracker);
                showToast('تم تحديث تاريخ الإنجاز.');
                if(document.getElementById('page-journal').classList.contains('active')) renderJournal();
            }
        };

        const updateCompassHeader = () => {
            const headerLinksContainer = document.getElementById('compass-header-links');
            const classSelect = document.getElementById('class-select');
            if(!headerLinksContainer || !classSelect) return;

            const classId = classSelect.value;
            const settings = getDb('teacherSettings');
            
            if (classId && settings[classId]) {
                const classInfo = settings[classId];
                const { levelId, unitId } = classInfo;
                const pathData = data[levelId]?.paths[unitId];
                const unitName = data[levelId]?.units[unitId - 1];
                const links = resourceLinks[levelId]?.[unitId];
                
                let headerHTML = '';

                if (pathData && unitName) {
                    headerHTML += `<h6 id="compass-class-info">${classInfo.className}، ${pathData.name}، ${unitName}</h6>`;
                }
                
                if (links) {
                    headerHTML += `
                        <div class="resource-links mt-2">
                            <a href="${links.path}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-folder"></i> موارد المسار</a>
                            <a href="${links.booklet}" target="_blank" class="btn btn-sm btn-outline-success"><i class="fas fa-book"></i> كراسة التلميذ</a>
                            <a href="${links.audio}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-headphones"></i> الموارد السمعية</a>
                        </div>
                    `;
                }
                headerLinksContainer.innerHTML = headerHTML;
                headerLinksContainer.classList.remove('d-none');
            } else {
                headerLinksContainer.classList.add('d-none');
                headerLinksContainer.innerHTML = '';
            }
        };

        const initializeApp = () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const darkModeSwitch = document.getElementById('darkModeSwitch');

            noteModalInstance = new bootstrap.Modal(document.getElementById('note-modal'));
            confirmationModalInstance = new bootstrap.Modal(document.getElementById('confirmationModal'));

            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            darkModeSwitch.checked = isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);

            renderInstructionsPage();
            addGlobalEventListeners();
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(link.dataset.target);
                });
            });
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('show'));
            darkModeSwitch.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode', darkModeSwitch.checked);
                localStorage.setItem('darkMode', darkModeSwitch.checked);
                if (document.getElementById('page-stats').classList.contains('active')) renderStatisticsPage();
            });
            
            const settings = getDb('teacherSettings');
            const initialPage = Object.keys(settings).length === 0 ? 'page-instructions' : 'page-stats';
            switchPage(initialPage);
        };
        
        initializeApp();

    })();


// --- PWA Service Worker Registration ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').then(registration => {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}

    </script>
</body>
</html>
